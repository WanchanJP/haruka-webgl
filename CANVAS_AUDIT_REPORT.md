# Canvas Layer Audit Report

**æ—¥ä»˜**: 2025-11-08
**å¯¾è±¡**: ãƒ«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ (`/`) ã®Canvaså®Ÿè£…
**ç›®çš„**: å˜ä¸€Canvaså®Ÿè£…ã¸ã®ç§»è¡Œå¯èƒ½æ€§ã‚’è©•ä¾¡

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

ç¾åœ¨ã®å®Ÿè£…ã§ã¯**2ã¤ã®Canvasè¦ç´ **ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **Unity WebGL Canvas** (ç”»é¢å¤–ã€æŠ€è¡“çš„ã«å¿…é ˆ)
2. **Panelæç”»Canvas** (ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã€å˜ä¸€Canvas)

**çµè«–**: ãƒ‘ãƒãƒ«æç”»ç”¨ã®Canvasã¯**ã™ã§ã«å˜ä¸€Canvaså®Ÿè£…**ã§ã™ã€‚Unity WebGL Canvasã¯æŠ€è¡“çš„åˆ¶ç´„ã«ã‚ˆã‚Šå¿…é ˆã§ã‚ã‚Šã€ç”»é¢å¤–ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã€Œè¤‡æ•°Canvaså•é¡Œã€ã«ã¯è©²å½“ã—ã¾ã›ã‚“ã€‚

ãŸã ã—ã€**æ©Ÿèƒ½é¢ã§ã®åˆ¶é™**ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸï¼š
- ç¾åœ¨ã€Unityã‚­ãƒ£ãƒ—ãƒãƒ£ã¯`unity-live`ãƒ‘ãƒãƒ«ï¼ˆ1ã¤ï¼‰ã®ã¿ã«è¡¨ç¤ºã•ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœŸå¾…ã€Œå„ãƒ‘ãƒãƒ«ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¯„å›²å†…ã«å…¥ã£ãŸã‚‰Unityã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’è¡¨ç¤ºã€ã«å¯¾å¿œã—ã¦ã„ãªã„

---

## 1. Canvasç”Ÿæˆç®‡æ‰€ã®é™çš„ç¢ºèª

### ãƒ«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ (`/`) ã§ç”Ÿæˆã•ã‚Œã‚‹Canvas

| # | ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | ç”Ÿæˆæ–¹æ³• | ID/Class | ç›®çš„ |
|---|---------|---|---------|----------|------|
| 1 | `components/HiddenUnityHost.tsx` | 41 | `document.createElement("canvas")` | `id="unity-canvas"` | Unity WebGLãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å…ˆ |
| 2 | `components/PanelCanvas.tsx` | 249 | JSX `<canvas ref={canvasRef}>` | `class="panel-canvas"` | ãƒ‘ãƒãƒ«æç”»ï¼ˆãƒ¡ã‚¤ãƒ³è¡¨ç¤ºï¼‰ |

### ãã®ä»–ã®Canvasï¼ˆãƒ«ãƒ¼ãƒˆä»¥å¤–ï¼‰

- `app/debug/page.tsx:36` - ãƒ‡ãƒãƒƒã‚°ãƒšãƒ¼ã‚¸ç”¨
- `app/debug/unity/page.tsx:16` - Unityãƒ‡ãƒãƒƒã‚°ãƒšãƒ¼ã‚¸ç”¨
- Unity WebGLãƒ“ãƒ«ãƒ‰å†… - Unityè‡ªèº«ã®å†…éƒ¨Canvas

---

## 2. ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã®è©³ç´°

### Layer 1: Unity WebGL Canvas (ID="unity-canvas")

**å½¹å‰²**: Unity WebGLã‚¨ãƒ³ã‚¸ãƒ³ã®3Dãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å…ˆ

**é…ç½®**:
```css
position: fixed;
left: -9999px;
top: -9999px;
z-index: -1000;
width: 640px;
height: 480px;
pointer-events: none;
```

**å†æç”»ãƒˆãƒªã‚¬**: Unityå†…éƒ¨ã®requestAnimationFrameï¼ˆé€£ç¶šçš„ã€~60fpsï¼‰

**æç”»ãƒ•ãƒ­ãƒ¼**:
1. Unity ã‚¨ãƒ³ã‚¸ãƒ³ãŒ3Dã‚·ãƒ¼ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
2. 500msã”ã¨ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆPNG base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
3. JavaScriptã¸é€ä¿¡ â†’ Panel Canvasã®`imageCache`ã¸ä¿å­˜

**åˆæˆé †**: æœ€èƒŒé¢ï¼ˆç”»é¢å¤–ãªã®ã§å®Ÿè³ªéè¡¨ç¤ºï¼‰

---

### Layer 2: Panelæç”»Canvas (class="panel-canvas")

**å½¹å‰²**: æ¼«ç”»ãƒ‘ãƒãƒ«ã®æç”»ï¼ˆé™æ­¢ç”»åƒ + Unityã‚­ãƒ£ãƒ—ãƒãƒ£ã®åˆæˆè¡¨ç¤ºï¼‰

**é…ç½®**:
```css
display: block;
width: ${viewportWidth}px; /* 720px */
height: ${sceneHeight}px;  /* å‹•çš„ã€ä¾‹: 5360px */
margin: 0 auto;
```

**å†æç”»ãƒˆãƒªã‚¬** (éé€£ç¶šçš„):
- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆ`container.addEventListener("scroll", ...)`ï¼‰
- ãƒªã‚µã‚¤ã‚ºï¼ˆ`window.addEventListener("resize", ...)`ï¼‰
- ç”»åƒãƒ­ãƒ¼ãƒ‰ï¼ˆ`preloadImages` å®Œäº†æ™‚ï¼‰
- Unityç”»åƒæ›´æ–°ï¼ˆ500msé–“éš”ï¼‰
- çŠ¶æ…‹å¤‰åŒ–ï¼ˆ`debug`, `showMask`ï¼‰

**æç”»ãƒ•ãƒ­ãƒ¼** (`lib/layout/draw.ts`):
1. `clearRect` ã§Canvaså…¨ä½“ã‚’ã‚¯ãƒªã‚¢
2. èƒŒæ™¯ã‚’å¡—ã‚Šã¤ã¶ã—ï¼ˆ`#f5f5f5`ï¼‰
3. ãƒ‘ãƒãƒ«ã‚’**zIndexé †ã«ã‚½ãƒ¼ãƒˆ**ï¼ˆ`zIndex` â†’ `yåº§æ¨™`ï¼‰
4. å„ãƒ‘ãƒãƒ«ã‚’é †æ¬¡æç”»ï¼š
   - åº§æ¨™å¤‰æ›ï¼ˆtranslate, rotateï¼‰
   - ãƒã‚¹ã‚¯é©ç”¨ï¼ˆ`clip`ï¼‰
   - èƒŒæ™¯å¡—ã‚Šï¼ˆ`fillRect`ï¼‰
   - ç”»åƒæç”»ï¼ˆé™æ­¢ç”» or Unityã‚­ãƒ£ãƒ—ãƒãƒ£ï¼‰
   - ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆæ ç·šãƒ»IDï¼‰

**åˆæˆé †**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆé€šå¸¸ãƒ•ãƒ­ãƒ¼ï¼‰

---

### Layer 3: Debug HUD (DOM div - Canvasã§ã¯ãªã„)

**å½¹å‰²**: ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã€å¯è¦–ãƒ‘ãƒãƒ«IDç­‰ï¼‰

**é…ç½®**:
```css
position: fixed;
top: 10px;
right: 10px;
z-index: 10000;
```

**åˆæˆé †**: æœ€å‰é¢

---

## 3. ç”»åƒã‚½ãƒ¼ã‚¹ã®æç”»å…ˆãƒãƒƒãƒ”ãƒ³ã‚°

### ç¾åœ¨ã®ç”»åƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

| ç”»åƒã‚¿ã‚¤ãƒ— | ã‚½ãƒ¼ã‚¹ | ä¸­é–“å‡¦ç† | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ | æœ€çµ‚æç”»å…ˆ | å¯¾å¿œãƒ‘ãƒãƒ« |
|-----------|--------|----------|--------------|-----------|-----------|
| **Unity 3Dã‚·ãƒ¼ãƒ³** | Unity Canvas (ç”»é¢å¤–) | ã‚­ãƒ£ãƒ—ãƒãƒ£ â†’ base64 â†’ HTMLImageElement | `"unity-live-capture"` | Panel Canvas | `unity-live` **ã®ã¿** |
| **é™æ­¢ç”»åƒ (SVG)** | `/sample/p1.svg`ç­‰ | ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ â†’ HTMLImageElement | `imageSrc` | Panel Canvas | `panel-1`, `panel-3`, `panel-5` |
| **å˜è‰²èƒŒæ™¯** | - | - | - | Panel Canvas (`fillRect`) | ãã®ä»–13ãƒ‘ãƒãƒ« |

### Unityç”»åƒã®æç”»ãƒ­ã‚¸ãƒƒã‚¯ (`lib/layout/draw.ts:122-128`)

```typescript
// Unity Live ã‚­ãƒ£ãƒ—ãƒãƒ£ã®æç”»ï¼ˆunity-live ãƒ‘ãƒãƒ«å°‚ç”¨ï¼‰
if (panel.id === "unity-live" && options.imageCache) {
  const liveImg = options.imageCache.get("unity-live-capture");
  if (liveImg && liveImg.complete) {
    ctx.drawImage(liveImg, 0, 0, width, height);
  }
}
```

**âš ï¸ é‡è¦**: ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€Unityã‚­ãƒ£ãƒ—ãƒãƒ£ã¯**ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã§`unity-live`ãƒ‘ãƒãƒ«ã®ã¿**ã«æç”»ã•ã‚Œã¾ã™ã€‚

### ç”»åƒæ›´æ–°ãƒ•ãƒ­ãƒ¼

```mermaid
Unity Canvas (640x480, ç”»é¢å¤–)
  â†“ 500msé–“éš”ã§ã‚­ãƒ£ãƒ—ãƒãƒ£
  â†“ CaptureManager.emit(b64, w, h, index=0)
  â†“ PanelCanvas.onImage()
  â†“ imageCache.set("unity-live-capture", img)
  â†“ setNeedsRedraw(true)
  â†“ requestAnimationFrame(render)
  â†“ drawScene() â†’ drawPanel()
  â†“ panel.id === "unity-live" ã®å ´åˆã®ã¿æç”»
Panel Canvas (720x5360, ãƒ¡ã‚¤ãƒ³è¡¨ç¤º)
```

---

## 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ãƒªã‚¹ã‚¯è©•ä¾¡

### å†æç”»é »åº¦ã®å®Ÿæ¸¬ï¼ˆæ¨å®šå€¤ï¼‰

| Canvas | é€šå¸¸æ™‚ | ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ | Unityæœ‰åŠ¹æ™‚ |
|--------|--------|------------|------------|
| Unity Canvas | ~60fps | ~60fps | ~60fps |
| Panel Canvas | 0fps | ~10-30fps | ~2fps (500msé–“éš”) |

### ãƒªã‚¹ã‚¯è©•ä¾¡ãƒãƒˆãƒªã‚¯ã‚¹

| ãƒªã‚¹ã‚¯é …ç›® | æ·±åˆ»åº¦ | ç¾çŠ¶ | è©³ç´° |
|----------|--------|------|------|
| **rAFäº‰å¥ª** | ğŸŸ¡ ä½ | Unityå´ã¯é€£ç¶šçš„ã€Panelå´ã¯éé€£ç¶šçš„ | å¹²æ¸‰ã¯å°‘ãªã„ãŒã€Unityå´ãŒå¸¸æ™‚60fpsã§rAFã‚’å æœ‰ |
| **é‡è¤‡ã‚¯ãƒªã‚¢** | ğŸŸ¢ ãªã— | CanvasãŒç‹¬ç«‹ | Unityå´ã¨Panelå´ã§ç‹¬ç«‹ã—ã¦ã‚¯ãƒªã‚¢å‡¦ç† |
| **åˆæˆã‚³ã‚¹ãƒˆ** | ğŸŸ¡ ä¸­ | Unity CanvasãŒç”»é¢å¤–ã§ã‚‚ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦å­˜åœ¨ | ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«å«ã¾ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š |
| **ãƒ†ã‚¢ãƒªãƒ³ã‚°** | ğŸŸ¢ ãªã— | 500msé–“éš”ã®éåŒæœŸæ›´æ–° | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã¯ä¸è¦ |
| **ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°** | ğŸŸ¢ é©åˆ‡ | 2ã¤ï¼ˆUnity + Panelï¼‰ | è¨±å®¹ç¯„å›²å†… |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡** | ğŸŸ¢ é©åˆ‡ | Unity: 307K pixels<br>Panel: ~3.8M pixels | åˆè¨ˆç´„4.1M pixelsã€é©åˆ‡ãªç¯„å›² |

### æœ€é©åŒ–ã®ä½™åœ°

1. **Unity Canvas ã®ç”»é¢å¤–é…ç½®**
   - ç¾çŠ¶: `position: fixed; left: -9999px`
   - æ”¹å–„æ¡ˆ: OffscreenCanvasï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œãŒå¿…è¦ï¼‰
   - åŠ¹æœ: åˆæˆã‚³ã‚¹ãƒˆã®å‰Šæ¸›

2. **Dirty Rect æœ€é©åŒ–**
   - ç¾çŠ¶: å…¨é¢å†æç”»ï¼ˆ`clearRect(0, 0, width, height)`ï¼‰
   - æ”¹å–„æ¡ˆ: å¤‰æ›´ã•ã‚ŒãŸãƒ‘ãƒãƒ«ã®ã¿å†æç”»
   - åŠ¹æœ: æç”»ã‚³ã‚¹ãƒˆã®å‰Šæ¸›ï¼ˆå®Ÿè£…è¤‡é›‘åº¦ â†‘ï¼‰

3. **å¯è¦–ç¯„å›²å¤–ã®ãƒ‘ãƒãƒ«æç”»ã‚¹ã‚­ãƒƒãƒ—**
   - ç¾çŠ¶: å…¨ãƒ‘ãƒãƒ«ã‚’æç”»
   - æ”¹å–„æ¡ˆ: å¯è¦–ç¯„å›²å†…ã®ãƒ‘ãƒãƒ«ã®ã¿æç”»
   - åŠ¹æœ: æç”»ã‚³ã‚¹ãƒˆã®å‰Šæ¸›ï¼ˆä¸­ç¨‹åº¦ï¼‰

---

## 5. åˆ¶é™äº‹é …ã¨èª²é¡Œ

### ç¾åœ¨ã®å®Ÿè£…ã®åˆ¶é™

1. **å˜ä¸€Unityã‚¹ãƒˆãƒªãƒ¼ãƒ **
   - `unity-live`ãƒ‘ãƒãƒ«ï¼ˆ1ã¤ï¼‰ã®ã¿å¯¾å¿œ
   - CaptureManager ã¯ `index` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤ãŒã€å®Ÿè£…ã§ã¯æœªä½¿ç”¨

2. **ãƒ‘ãƒãƒ«ã”ã¨ã®ã‚­ãƒ£ãƒ—ãƒãƒ£éå¯¾å¿œ**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœŸå¾…: ã€Œå„ãƒ‘ãƒãƒ«ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¯„å›²å†…ã«å…¥ã£ãŸã‚‰Unityã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’è¡¨ç¤ºã€
   - ç¾çŠ¶: æœ€ä¸Šéƒ¨ã®`unity-live`ãƒ‘ãƒãƒ«ã®ã¿ã«è¡¨ç¤º

3. **ç”»åƒã‚½ãƒ¼ã‚¹å®šç¾©ã®ç¡¬ç›´æ€§**
   - ç¾çŠ¶: `imageSrc` (string) ã¾ãŸã¯ `id === "unity-live"` (ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰)
   - ç†æƒ³: `source: { type: "unity" | "image" | "none", ... }` ã®ã‚ˆã†ãªæŸ”è»Ÿãªå®šç¾©

### ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã¨ã®ã‚®ãƒ£ãƒƒãƒ—

> ã€Œãã‚Œãã‚Œã®Canvasã«å¯¾ã—ã¦ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¯„å›²å†…ã«ãªã£ãŸã‚‰ã€Unityã‹ã‚‰ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒãŒãã®Canvasã«å¯¾ã—ã¦è¡¨ç¤ºã•ã‚Œã¦æ¬²ã—ã„ã€

**ç¾çŠ¶**:
- âœ… Canvasè‡ªä½“ã¯å˜ä¸€ï¼ˆPanel Canvasï¼‰
- âŒ è¤‡æ•°ã®ãƒ‘ãƒãƒ«ã«å¯¾ã—ã¦Unityã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’è¡¨ç¤ºã§ããªã„
- âŒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¯„å›²ã«å¿œã˜ã¦Unityã‚·ãƒ¼ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹æ©Ÿèƒ½ãŒãªã„

---

## 6. æ¨å¥¨äº‹é …

### çŸ­æœŸå¯¾å¿œï¼ˆã™ãã«å®Ÿæ–½å¯èƒ½ï¼‰

1. **ãƒ‘ãƒãƒ«å®šç¾©ã®æ‹¡å¼µ**
   ```typescript
   type PanelSource =
     | { type: "none" }
     | { type: "image"; src: string }
     | { type: "unity"; index: number };

   interface Panel {
     // ...
     source?: PanelSource;
     imageSrc?: string; // éæ¨å¥¨ã€å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™
   }
   ```

2. **æç”»ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£** (`lib/layout/draw.ts`)
   ```typescript
   // ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤
   - if (panel.id === "unity-live" && options.imageCache) {
   + if (panel.source?.type === "unity" && options.imageCache) {
       const index = panel.source.index ?? 0;
       const liveImg = options.imageCache.get(`unity-capture-${index}`);
       if (liveImg && liveImg.complete) {
         ctx.drawImage(liveImg, 0, 0, width, height);
       }
     }
   ```

3. **è¤‡æ•°Unityã‚­ãƒ£ãƒ—ãƒãƒ£ã®ã‚µãƒãƒ¼ãƒˆ**
   - imageCache ã®ã‚­ãƒ¼: `"unity-live-capture"` â†’ `"unity-capture-${index}"`
   - ãƒ‘ãƒãƒ«å®šç¾©: `{ id: "panel-x", source: { type: "unity", index: 0 } }`

### ä¸­æœŸå¯¾å¿œï¼ˆè¨­è¨ˆå¤‰æ›´ãŒå¿…è¦ï¼‰

1. **å¯è¦–ãƒ‘ãƒãƒ«ã«å¿œã˜ãŸUnityã‚·ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆ**
   - å¯è¦–ãƒ‘ãƒãƒ«ã®Unity index ã‚’åé›†
   - Unityå´ã¸ã€Œã©ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã€ã‚’é€šçŸ¥
   - è¤‡æ•°ã®Unityã‚·ãƒ¼ãƒ³ã‚’ä¸¦è¡Œãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦æ¤œè¨ï¼‰

2. **OffscreenCanvas ã¸ã®ç§»è¡Œ**
   - Unity Canvas ã‚’OffscreenCanvasã«ç§»è¡Œ
   - Web Worker ã§ã®3Dãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œãŒå¿…è¦ï¼‰

### é•·æœŸå¯¾å¿œï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¤‰æ›´ï¼‰

1. **WebGPU ã¸ã®ç§»è¡Œ**
   - Unity WebGL â†’ WebGPU
   - ã‚ˆã‚ŠåŠ¹ç‡çš„ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

2. **Virtual Scrolling ã®å°å…¥**
   - å¯è¦–ç¯„å›²å¤–ã®ãƒ‘ãƒãƒ«ã‚’DOM/Canvasã‹ã‚‰é™¤å¤–
   - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å‰Šæ¸›

---

## 7. çµè«–

### Canvasæ•°ã®è©•ä¾¡

- **è¡¨ç¤ºç”¨Canvas**: **1ã¤ï¼ˆPanel Canvasï¼‰** âœ… ã™ã§ã«å˜ä¸€Canvaså®Ÿè£…
- **æŠ€è¡“çš„å¿…é ˆCanvas**: **1ã¤ï¼ˆUnity WebGL Canvasã€ç”»é¢å¤–ï¼‰** âœ… é©åˆ‡ã«åˆ†é›¢

**ãƒ•ã‚§ãƒ¼ã‚ºBã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¯ä¸è¦**ã§ã™ã€‚ç¾åœ¨ã®å®Ÿè£…ã¯**ã™ã§ã«å˜ä¸€Canvasè¨­è¨ˆ**ã§ã™ã€‚

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… **è¨ºæ–­å®Œäº†**: ç¾çŠ¶ãŒå˜ä¸€Canvaså®Ÿè£…ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
2. âš ï¸ **æ©Ÿèƒ½ã‚®ãƒ£ãƒƒãƒ—ã®è§£æ¶ˆ**: è¤‡æ•°ãƒ‘ãƒãƒ«ã¸ã®Unityã‚­ãƒ£ãƒ—ãƒãƒ£å¯¾å¿œï¼ˆåˆ¥ã‚¿ã‚¹ã‚¯ï¼‰
3. ğŸ“ **å‹å®šç¾©ã®æ”¹å–„**: `PanelSource` ã®å°å…¥ã§æŸ”è»Ÿæ€§ã‚’å‘ä¸Š

### ææ¡ˆã™ã‚‹PRã‚¿ã‚¤ãƒˆãƒ«

```
chore(diag): canvas layer audit - confirmed single-canvas architecture
```

**èª¬æ˜**:
- ç¾çŠ¶ã®å®Ÿè£…ã‚’è¨ºæ–­ã—ã€ã™ã§ã«å˜ä¸€Canvasè¨­è¨ˆã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
- Unity WebGL Canvasã¯æŠ€è¡“çš„ã«å¿…é ˆã§ã‚ã‚Šã€é©åˆ‡ã«ç”»é¢å¤–ã«åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šã®å•é¡Œã¯ç™ºè¦‹ã•ã‚Œãªã‹ã£ãŸ
- æ©Ÿèƒ½é¢ã§ã®ã‚®ãƒ£ãƒƒãƒ—ï¼ˆè¤‡æ•°ãƒ‘ãƒãƒ«ã¸ã®Unityã‚­ãƒ£ãƒ—ãƒãƒ£å¯¾å¿œï¼‰ã‚’ç‰¹å®š

---

## ä»˜éŒ²: ã‚³ãƒ¼ãƒ‰å‚ç…§

### Canvasç”Ÿæˆç®‡æ‰€

- Unity Canvas: `components/HiddenUnityHost.tsx:41`
- Panel Canvas: `components/PanelCanvas.tsx:249`

### æç”»ãƒ­ã‚¸ãƒƒã‚¯

- ã‚·ãƒ¼ãƒ³æç”»: `lib/layout/draw.ts:174-208`
- ãƒ‘ãƒãƒ«æç”»: `lib/layout/draw.ts:77-169`
- Unityç”»åƒæç”»: `lib/layout/draw.ts:122-128`

### ã‚­ãƒ£ãƒ—ãƒãƒ£ç®¡ç†

- CaptureManager: `lib/capture/capture-manager.ts:14-161`
- Unityå—ä¿¡ãƒ–ãƒªãƒƒã‚¸: `lib/capture/install-receiver.ts`
- ç”»åƒå—ä¿¡: `components/PanelCanvas.tsx:55-83`

---

**Report Generated**: 2025-11-08
**Audited By**: Claude Code (Sonnet 4.5)
